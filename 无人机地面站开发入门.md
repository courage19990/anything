# 无人机地面站开发

## 从现有的东西出发

PX4是一个固件，核心操作系统是NuttX实时ARM系统，ARM是一款RISC微处理器 ，RISC是精简指令集计算机。
GCS=Ground Control Station
UAV=Unmanned Aerial Vehicle

.NET的核心技术是.NET Framework
.NET Framework=CLR（相当于JVM）+基类库(相当于JDK)
.NET Core主要是跨平台
.NET Framework主要是运行于Windows
C#编写的是托管程序，必须有.NET framework才可运行，而c和c++则不要。

USB是一种高速的串口通讯协议
串行接口=串口Serial Interface
注意port和Interface是同义词
serial port
an interface 
(commonly used for modems and mice and some printers) 
that transmits data a bit 
at a time

无线通信：电磁波信号可以在自由空间中传播
有线通信：利用金属导线、光纤等有形媒质传送信息

有线通信可以转化为无线通信，方法是用某个中继系统。

现在我们已经可以通过USB方式与PX4建立物理连接



## 接下来就是怎么和无人机进行通信的问题

__01 成功打开并运行simple_example__

__02 宏观上梳理simple_example做了啥（确保物理连接、串口通信、接收消息、发消息）__

__03 补充知识：__总的来说，飞控连接电脑是一种USB-to-COM虚拟串口。BaudRate波特率，也就是串口通讯的速度，进行串口通讯的双方其波特率需要相同，如果用PC连接其他非PC系统，一般地，波特率由非PC系统决定。波特率表示每秒钟传送的码元符号的个数，是衡量“数据传送速率”的指标，它用单位时间内载波调制状态改变的次数来表示。单片机或计算机在串口通信时的速率。单位“波特”本身就已经是代表每秒的调制数，以“波特每秒”（Baud per second）为单位是一种常见的错误。波特率与比特率的关系也可换算成：比特率=波特率*单个调制状态对应的二进制位数。例如假设数据传送速率为120符号/秒(symbol/s)(也就是波特率为120Baud)，又假设每一个符号为八相调制(单个调制状态对应3个二进制位)，则其传送的比特率为(120symbol/s) * (3bit/symbol)=360bps

意思是__一个symbol的可能状态数要用3位二进制数字表达__（注：1字节byte=8bit比特、位），只有同时知道波特率和一个symbol的bit数才能知道比特率，即运输速度。

顺便一提：serialPort1.DataBits的默认值是8也就是1个字节，8bit/symbol

现在的问题是BaudRate是由谁来定的？是可以自定义还是由飞控决定？暂且搁置



__04.1 仿制一款简单的串口通信工具__

【a】

打开串口.

【b】

listBox如何添加消息 如何不可選中 如何總是滾動到最下面

窗口如何固定大小，不可resize

listBox1.ItemHeight在构造器里值为18 和 初始值一致

但在方法中变为 12 不懂原因在哪 所以 暂时 进行实时计算

【c】

一旦连接成功，飞控开始源源不断向PC返回数据

BytesToRead和ReadBufferSize不关心后者

飞控大体遵循以17个字节/每秒返回数据

看看这17个字节里面有啥 



__04.2 MAVLink协议入门__（Micro Air Vehicle Link）

对一个具体的17个字节进行分析

将listBox里的内容复制出来

【254-9-136-1-1-0】 【 -0-0-0-0-2-3-81-3-3-】【197-56】

前6个字节

254标识一个消息包的开始，恒为254（PS. fe(十六进制) = 254(十进制)=11111110(二进制)）

9标识消息里的负载内容的长度，这里说明负载长度为9

136序列码，每发一个消息包加序列码的值1，可用来计算丢包率

1标识发消息的系统

1标识发消息的组件

0表示消息种类---这里是心跳包的意思

第7到第15（7+9-1）位是数据，依赖于消息ID

第16和17位是校验码Check-sum of the entire packet, excluding the packet start sign (LSB to MSB)

根据官方文档#0解析【 -0-0-0-0-2-3-81-3-3-】含义

0 MAV TPYE 交通工具或部件类型 --- Generic micro air vehicle

0 autopilot 飞控类型 --- Generic autopilot, full support for everything

0 base_mode 飞行模式，需要自定义？含义不明

0-2-3-81 custom mode 飞控现在所处的飞行模式，这个参数要看各个飞控自己的定义方式，会有不同的组合、计算方式。A bitfield for use for autopilot-specific flags

3 system_status --- 该值没对应的？？查源代码枚举变量注释也没有，只有0是对应Uninitialized system, state is unknown.

3 mavlink_version 协议版本

补充知识：

1字节     uint8_t
2字节     uint16_t
4字节     uint32_t
8字节     uint64_t



__04.3 心跳协议__

https://mavlink.io/en/services/heartbeat.html

组件必须定期广播`HEARTBEAT`并监视来自其他组件/系统的心跳

简而言之，对于其它组件而言，有心跳说明还连接着那个组件，没心跳则说明已经断开了。正常的心跳（广播）速率应该是1Hz（每秒一次）

其次，还可用通过心跳判断载具类型、飞行状态，以此来决定地面站GUI的布局、表现方法。



__04.4 获取心跳之外的消息__

如果什么都不做的话，飞控将源源不断地发送“心跳”消息，现在我们需要获取“心跳”以外的消息，势必就需要发送一些消息到飞控，告知它发送其它的一些消息。

我们想得到什么消息：最关键的是，飞控的1高度、2gps定位，3以及飞行状态

最直接、简单的方法就是查看simple_example源代码，其次为通读mavlink文档，几个问题：

1-异步和System.Threading.Thread.Sleep的必要性

2-线程间操作无效 从不是创建控件XXX 的线程访问它。就是没法在其它线程更新GUI了。

3-c#中的try catch语句 

4-c#中的lock语句 













