[TOC]

## GCS的C#部分开发思路

对那个 MAVLink包 的讲解。它做了相当多繁琐多的工作。应该适当地阐述一些。例如那个校验和。

### 1 一些基础知识

首先要会打开VS

然后需要会创建一个Solution

创建一个桌面程序。

这里阐述一下包管理工具啥的使用。

### 2 这里开始OOP启动！

我是采取一个面向对象的开发思想。

将一启动程序就启动的那个窗体类称作Entrance

一经启动就会同时开启一个web socket后台服务器

考虑到程序的可扩展性。既可以在该后台软件的基础上设计一个C#前端。所以我保留以下代码，通过简单修改就可以用：这里放辣个代码

我个人实现的是一个浏览器前端。所以在创建Entrance类对象的同时，创建了一个web socket后台服务器类对象。顾名思义，该类抽象表示一个web socket服务器。默认的什么来着为ws://127.0.0.1:8080

经过我的封装（有兴趣可以打开看 其实就两行代码），假设我有一个该类的对象server。那么我可以通过server.sendMessage向所有与该服务器通信的浏览器端发送实时的web socket协议消息。

然后我采取叫做啥的工具，将MavLink消息对象，直接转化为JSON格式便于前端进行解析并处理。

发浏览器这个操作，要强调是一个创新。



辣么下面开始进入主要部分

随着 E类对象的创建，同时也创建了一个GCS4MAVLink类对象，我用该类来抽象代表一个无人机地面站。这里保留了未来多无人机的可能性。倘若服务有多个无人机。那么创建多个该类对象就可以了。至于多无人机数据的可视化显示 。同样只需要创建多个web socket服务器。通过不同的地址端口 ，开启多个网页，就可以了。牛逼！



那么GCS4MAVLink类对象做了什么事情呢。

该类对象提供了 一个startup方法， 我们只需要传入相应的 端口号和波特率就可以 去连接一个 无人机飞控。

以及我们必须传入一个 消息处理器，对来自无人机 的数据进行响应。

GCS4MAVLink类对象一旦创建，并调用startup方法就会按x频率 向飞控发送 心跳包以及请求数据包。

倘若需要扩展更多的数据交互方法，扩展此类即可。具体方法可以参考MP的开源代码simple example



GCS4MAVLink类对象具体怎样和垃个飞控交互，又是借助一个飞控类对象。该类用于抽象表示飞控，实际上是一个SerialPort对象的代理人。但是我们在程序里把它视为飞控就可以了。特别的方法只有GetPacket以及ReceiveBytes，前者用于从飞控读取一个MAVLink包（解析字节码过程由MAVLink包完成了）。后者用于向飞控发送字节流。只需要把创建好的MAVLink消息字节作为参数传递进去即可。



一个总共只有4个自定义类的简易无人机后台就搭建好了。

接下来进入前端部分。



### 实际

编写C#端的程序，我主要采用了面向对象的开发思想。

我将一启动地面站就首先弹出来的那个窗体，定义为Entrance类，即地面站的入口。一旦启动地面站，Entrance类对象会首先被创建。考虑到程序后续的可扩展性。即可以在原基础上添加一个C#版本的前端，我保留了以下代码。通过简单修改就可以使用：

我个人选择实现的是一个浏览器的前端。所以在创建Entrance类对象的同时，创建了一个MyWebSocketServer类对象。顾名思义，该类抽象表示一个WebSocket服务器。默认的地址为ws://127.0.0.1:8095。该地址可以很容易地在程序中修改。经过我的封装，有兴趣的读者可以亲自看一看，其实只有非常少的代码。假设我已经创建该类的一个对象，其引用为s。那么我们就可以通过调用s.sendMessage方法向所有与该地面站后台连接的浏览器发送的WebSocket消息。在将消息发出去之前，我们需要先将MavLink消息对象转化为JSON格式以便前端进行处理。

下面进入C#端程序的主要部分。

随着Entrance类对象、MyWebSocketServer类对象的创建，同时还将创建一个GCS4MAVLink类对象，我用该类来抽象代表一个无人机地面站。这里保留了未来多无人机的可能性。倘若地面站监控多个无人机。那么就需要创建多个GCS4MAVLink类对象。而来自多无人机数据的可视化，只需创建多个MyWebSocketServer类对象并绑定不同的地址、端口。最后，通过浏览器开启多个网页分别连接不同的“WebSocket服务器”地址、端口就可以实现对多无人机的监控。

那么GCS4MAVLink类对象做了什么事情呢？该类对象提供了一个startup方法，在确保物理连接没问题之后，我们只需要向该方法传入相应的端口号和波特率作为参数就可以去连接一个无人机飞控。以及我们必须传入一个消息处理器，对来自无人机的数据进行响应。GCS4MAVLink类对象一旦创建，并调用startup方法就会按确定的频率向无人机飞控发送心跳包并请求除“心跳”外的其它数据，例如飞行姿态、GPS位置等等。倘若需要扩展更多的数据交互方法，扩展此类即可。

GCS4MAVLink类对象具体怎样和飞控交互呢？又是借助一个Autopilot类对象。该类对象用于抽象表示一个具体的飞控，实际上是一个SerialPort对象的代理人。但是我们在编写程序的过程中直接将其视为飞控就可以了。在Autopilot类中，特别的方法只有GetPacket以及ReceiveBytes，前者用于从飞控读取一个MAVLink包，解析字节的过程由MAVLink包代我们完成了。后者则用于地面站向飞控发送MAVLink消息包。只需把创建好的MAVLink消息包所对应的字节串作为参数，调用该方法即可。

至此，借助于一系列外部依赖，一个总共只有4个自定义类的简易无人机后台就搭建好了。由于充分采取了面向对象的思想，该程序完全具备良好的可读性，以及可扩展性。















