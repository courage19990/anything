## 无人机通信协议

### 1 基于MAVLink的基本通信流程

无人机与地面站进行通信，本质上就是在互相发送字节。而一串字节所代表的含义，就由无人机通信协议所规定。同时，无人机通信协议还规定了无人机与地面站在通信时所需遵循的一系列动作。商业无人机的通信协议通常是不对外公开的。而MAVLink则是业余无人机爱好者广泛采用的一种小型无人机通信协议。本地面站将基于该协议进行开发。

MAVLink规定，处在某一网络中的无人机组件必须按一定频率向其余组件广播一种名叫“心跳”的消息包，在本文中简称为心跳包（HEARTBEAT）。心跳包的主要用来标识一个组件是否连接到网络。如果定期收到某件的心跳包，则认为该组件已连接到网络；如果未收到许多预期的心跳包，则可以认为该组件已经断开。我们还可以通过心跳包来判断地面站与无人机之间信号的强弱、判断载具类型、飞行状态等。

因此，地面站一旦与无人机建立连接，就会源源不断地收到来自于无人机的心跳包。然后地面站同样地也按照一定频率向无人机发送心跳包。之后，地面站必须发送一个非常关键的MAVLink消息包，它在文档中的名称叫做REQUEST_DATA_STREAM，地面站通过这个消息包向无人机请求各种各样的实时数据，无人机接收到这个消息包就按照地面站所请求的频率返回各种实时数据。直到地面站发送特定的消息报才会结束。至此，就完成了无人机与地面站之间最简单的一个通信流程。



### 2 手动解析MAVLink消息包

在详细介绍MAVLink消息报格式之前，首先建立一个较直观的认识。

我们通过串口通信工具sscom5抓取来自无人机的消息包，并尝试去解析它。

如下图所示



这就是在上文中所介绍的心条包

它本质上就是一串字节。

我们来解读该串字节的含义，这需要官方文档的帮助。











### 3 通过C#发送MAVLink消息包

在我们用C#编程实现地面站的时候，并不需要自己来解析MAVLink消息包。而是通过引用一个开源的由xml定义所生成的库，它将关于MAVLink消息包的一切都封装好了。因此，实际上，我们可以完全不需要知道上述细节，只需要懂得其通信流程，会查官方文档就可以了。

一个简单的示例代码如下：

