## 一、基于MAVLink的基本通信流程

　　无人机要与地面站进行通信，就需要遵循一系列的规定，就好像我们与外国人交流经常采用英文，并且一般需要用“你好”之类的敬语开始一段对话。如果我们不懂英文或者不懂礼貌，就很有可能没法正常的交流，这是我们日常生活中所遵循的“协议”。无人机与地面站进行通信，本质上则是在互相发送字节串。而一串字节所代表的含义，要由一定的无人机通信协议所规定。同时，无人机通信协议还规定了无人机与地面站在通信时所需遵循的一系列动作。商业无人机的通信协议通常是不对外公开的。而MAVLink则是业余无人机爱好者广泛采用的一种小型无人机通信协议。本地面站将基于该协议进行开发。

　　MAVLink规定，处在某一网络中的无人机组件必须按一定频率向其余组件广播一种名叫“心跳”的消息包，在本文中简称为心跳包（HEARTBEAT）。心跳包主要用来标识一个组件是否连接到网络。如果定期收到某组件的心跳包，则认为该组件已连接到网络；如果未收到许多预期的心跳包，也就是“没心跳”了，则可以认为该组件已经断开。我们还可以通过心跳包来判断地面站与无人机之间信号的强弱，判断无人机的类型、状态等。

　　因此，地面站一旦与无人机建立连接，就会源源不断地收到来自于无人机的心跳包。然后，地面站同样地也可以按照一定频率向无人机发送心跳包，但这并非是强制的。之后，为了获取无人机相关的实时数据。地面站必须发送一个非常关键的MAVLink消息包，它在文档中的名称叫做REQUEST_DATA_STREAM，即“请求数据流”。地面站通过该消息包向无人机请求各种各样的实时数据。无人机一旦接收到该消息包，就按照地面站所要求的频率返回请求的实时数据。直到地面站发送特定的消息包才会结束。至此，就完成了无人机与地面站之间最简单的一个通信过程。如下图所示。

![img](https://img2020.cnblogs.com/i-beta/1042431/202003/1042431-20200315153541438-14363460.png)

## 二、手动解析MAVLink消息包

　　在详细介绍MAVLink消息包格式之前，先建立一个较直观的认识。我们通过串口调试工具sscom5抓取来自无人机飞控的消息包，并尝试手动去解析它。sscom5所接收到的来自无人机飞控的数据如下图所示。

![img](https://img2020.cnblogs.com/i-beta/1042431/202003/1042431-20200315180602274-1610639343.png)

　　可以清晰的看到，所谓MAVLink消息包，本质就是一串字节。并没有什么神奇之处。我们从中复制任意一串字节进行解析。例如FE 09 35 01 01 00 00 00 00 00 02 03 51 03 03 43 AF。这是一串16进制数。要解读该串字节的含义，需要官方文档的帮助。笔者在这里直接给出答案：FE代表一个MAVLink消息包的开始，而09代表该消息包有效负载的长度，显而易见，35是消息包的序列号，再之后的两个字节，分别是系统ID和组件ID，再往后的00，此字节最为关键，称为“消息ID”，代表着“消息类型”。而00正说明这是一个心跳包。9个字节则是有效负载的内容，这通常是我们真正感兴趣的内容。最后两个字节则是校验码，主要用于确保消息包的完整性。如果要继续解析有效负载的含义，就必须求助于官方文档了（ 网址为[https://mavlink.io/en/messages/common.html](https://mavlink.io/en/messages/common.html)）。

![img](https://img2020.cnblogs.com/i-beta/1042431/202003/1042431-20200315200745450-1724764777.png)

 　　一个一般的MAVLink消息包的构成和上述的心跳包没有太大不同。真正区分MAVLink消息包的是“消息ID”，以及由“消息ID”所决定的负载长度、有效负载。所以，消息ID是最关键的。一般的MAVLink消息包的构成如下图所示。

![img](https://img2020.cnblogs.com/i-beta/1042431/202003/1042431-20200315205042755-462038130.png)

　　对上述结构的一个具体说明：

- STX：消息的起始符。占1个字节，值恒为0xFE。
- LEN：有效负载长度，也就是PAYLOAD的长度。本身占1个字节。
- SEQ：包序号。占1个字节，在0和255之间按顺序轮转。
- SYS：系统ID。占1个字节，用于区分发送系统。
- COMP：组件ID。占1个字节，用于区分发送组件。
- MSG：消息ID。占1个字节，标识消息类型，定义有效负载的含义。
- PAYLOAD：实际数据。其长度、含义取决于消息类型。
- CKA与CKB：校验和。占2个字节。用于错误检测。

　　注意，MAVLink 2.0版本已经发行了。但本文所介绍的仍然是MAVLink 1.0版本。在实际编程中，并不需要过多地关注这些细节，仅需知道消息包的类型，以及它包含哪些数据。除此之外，学会查询文档就可以了。

## 三、通过C#发送MAVLink消息包

　　在我们用C#编程实现地面站的时候，并不需要自己来解析MAVLink消息包，而是通过引用一个由xml精准定义，并通过程序自动生成的外部库来完成该项任务。也就是说，我们不需要写关于MAVLink底层的任何一行代码。这个外部库将关于MAVLink的一切都封装好了。因此，实际上，我们完全不需要知道上述的细节，只需懂得通信流程，会查官方文档就可以了。一个简单的示例代码如下：

```c#
                        // 创建请求数据流的MAVLINK消息包，这里令req_message_rate=7，调高些可以提高数据的实时性，但对硬件有更高要求
                        var buffer = mavlink.GenerateMAVLinkPacket10(MAVLink.MAVLINK_MSG_ID.REQUEST_DATA_STREAM,
                            new MAVLink.mavlink_request_data_stream_t()
                            {
                                req_message_rate = 7,
                                req_stream_id = (byte)MAVLink.MAV_DATA_STREAM.ALL,
                                start_stop = 1,
                                target_component = compid,
                                target_system = sysid
                            });
                        // 向飞控发送请求数据流的MAVLINK消息包
                        autopilot.ReceiveBytes(buffer);
                        // 创建心跳包
                        buffer = mavlink.GenerateMAVLinkPacket10(MAVLink.MAVLINK_MSG_ID.HEARTBEAT, hb);
                        // 向飞控发送心跳包
                        autopilot.ReceiveBytes(buffer);
```